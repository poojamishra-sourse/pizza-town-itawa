// Pizza Town â€“ MongoDB Prisma Schema (FINAL UPDATED)
// String IDs + native @db.ObjectId + auto()
// Includes: user profile (dob, gender, extra), item option groups/options,
// cart & order option snapshots, order & delivery instructions.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  DELIVERY
}

enum OrderStatus {
  PLACED
  CONFIRMED
  IN_KITCHEN
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  UPI
  CARD
}

enum DeliveryStatus {
  PENDING
  ACCEPTED
  AT_STORE
  PICKED_UP
  EN_ROUTE
  DELIVERED
}

//
// USERS
//
model User {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  role             UserRole @default(CUSTOMER)
  name             String?
  email            String?  @unique
  phone            String?  @unique
  passwordHash     String?
  avatarUrl        String?
  defaultAddressId String?

  // ðŸ‘‡ added profile fields
  dob              DateTime?
  gender           String?          // "male" | "female" | "other" (use enum in app layer if you want)
  additionalInfo   Json?            // arbitrary profile data

  addresses        Address[]
  carts            Cart[]
  orders           Order[]
  reviews          Review[]
  notifications    Notification[]
  deliveryProfile  DeliveryProfile?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Address {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId

  label     String?
  line1     String
  line2     String?
  landmark  String?
  city      String
  state     String
  pincode   String
  location  Json?     // GeoJSON Point if you like
  isDefault Boolean   @default(false)

  user      User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

//
// RESTAURANT / CATALOG
//
model Restaurant {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  slug          String   @unique
  phone         String?
  address       String?
  active        Boolean  @default(true)

  categories    Category[]
  items         Item[]
  orders        Order[]
  analytics     AnalyticsDaily[]
  reviews       Review[]
  carts         Cart[]

  createdAt     DateTime @default(now())
}

model Category {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  name         String
  active       Boolean @default(true)

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  items        Item[]
}

model Item {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  categoryId   String   @db.ObjectId
  name         String
  description  String?
  price        Float
  image        String?
  isVeg        Boolean  @default(true)
  active       Boolean  @default(true)

  // optional extras for discovery/filters
  tags         String[] // e.g. ["bestseller","spicy"]
  spicyLevel   Int?     // 0-3 etc.

  restaurant   Restaurant      @relation(fields: [restaurantId], references: [id])
  category     Category        @relation(fields: [categoryId], references: [id])
  optionGroups ItemOptionGroup[]   // ðŸ‘ˆ multiple option groups

  orderItems   OrderItem[]
  cartItems    CartItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ðŸ‘‡ Item customization models
model ItemOptionGroup {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  itemId    String  @db.ObjectId
  name      String              // Size, Crust, Toppings, Extras
  multiple  Boolean @default(false) // true = MULTI select (e.g. toppings)
  required  Boolean @default(false)
  sortOrder Int     @default(0)

  item      Item       @relation(fields: [itemId], references: [id])
  options   ItemOption[]
}

model ItemOption {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  groupId   String  @db.ObjectId
  label     String  // "Medium", "Cheese Burst", "Extra Cheese"
  price     Float   @default(0.0)
  sortOrder Int     @default(0)
  active    Boolean @default(true)

  group     ItemOptionGroup @relation(fields: [groupId], references: [id])
}

//
// CART
//
model Cart {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  restaurantId String   @db.ObjectId

  user         User       @relation(fields: [userId], references: [id])
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  items        CartItem[]
}

model CartItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  cartId    String  @db.ObjectId
  itemId    String  @db.ObjectId
  quantity  Int     @default(1)
  price     Float                 // base price at add-to-cart time

  // ðŸ‘‡ store chosen options by ids for easy mutate
  // [{ groupId: "...", optionIds: ["...","..."] }]
  options   Json?

  cart      Cart @relation(fields: [cartId], references: [id])
  item      Item @relation(fields: [itemId], references: [id])
}

//
// ORDER
//
model Order {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  userId         String        @db.ObjectId
  restaurantId   String        @db.ObjectId

  status         OrderStatus   @default(PLACED)
  paymentStatus  PaymentStatus @default(PENDING)

  items          OrderItem[]

  subtotal       Float
  tax            Float
  deliveryFee    Float
  total          Float

  addressSnap          Json?      // delivery address snapshot
  instructions         String?    // food prep instructions
  deliveryInstructions String?    // ðŸ‘ˆ delivery-related instructions (ring bell, leave at door)

  // optional status timeline for tracking UI
  timeline       Json?   // [{status, at, note}]

  payment        Payment?
  deliveryTask   DeliveryAssignment?
  review         Review?

  user           User        @relation(fields: [userId], references: [id])
  restaurant     Restaurant  @relation(fields: [restaurantId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String  @db.ObjectId
  itemId    String? @db.ObjectId
  nameSnap  String               // item name snapshot
  price     Float                // unit price snapshot
  quantity  Int

  // ðŸ‘‡ snapshot of chosen options with labels & prices (stable even if menu changes)
  // [{ groupName: "Size", options: [{label:"Medium", price:30}]}]
  optionsSnap Json?

  order     Order @relation(fields: [orderId], references: [id])
  item      Item? @relation(fields: [itemId], references: [id])
}

//
// PAYMENT
//
model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String        @unique @db.ObjectId
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amount        Float
  gatewayInfo   Json?         // razorpay/stripe payloads

  order         Order @relation(fields: [orderId], references: [id])
}

//
// DELIVERY
//
model DeliveryProfile {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @unique @db.ObjectId
  isOnline      Boolean  @default(false)
  vehicleType   String?
  earnings      Float    @default(0)

  user          User @relation(fields: [userId], references: [id])
  assignments   DeliveryAssignment[]
}

model DeliveryAssignment {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String         @unique @db.ObjectId
  deliveryId    String?        @db.ObjectId
  status        DeliveryStatus @default(PENDING)

  distanceKm    Float?
  payAmount     Float?
  specialNote   String?        // ðŸ‘ˆ instruction for delivery partner

  order         Order            @relation(fields: [orderId], references: [id])
  delivery      DeliveryProfile? @relation(fields: [deliveryId], references: [id])
}

//
// REVIEWS
//
model Review {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  orderId      String   @unique @db.ObjectId
  restaurantId String   @db.ObjectId
  rating       Int
  comment      String?

  user         User       @relation(fields: [userId], references: [id])
  order        Order      @relation(fields: [orderId], references: [id])
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
}

//
// NOTIFICATIONS
//
model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  title     String
  message   String?
  data      Json?
  readAt    DateTime?

  user      User? @relation(fields: [userId], references: [id])
}

//
// ANALYTICS (daily snapshot, materialized by cron/job)
//
model AnalyticsDaily {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId   String   @db.ObjectId
  date           DateTime
  ordersCount    Int      @default(0)
  revenue        Float    @default(0)
  topItems       Json?    // [{itemId,name,qty}]

  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])
}
